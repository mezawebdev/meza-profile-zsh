#!/bin/bash

# Configuration
INPUT_DIR=""
OUTPUT_DIR="webp_output"
RESIZE_WIDTH=1000  # Target width in pixels, height will be auto-calculated
WEBP_QUALITY=90   # WebP quality (0-100). 80 is a good balance.

# --- Functions ---

usage() {
    echo "Usage: $0 -i <input_directory> [-o <output_directory>] [-w <width>] [-q <quality>]"
    echo "Converts all common image types in the input directory to WebP format."
    echo "Resizes images to the specified width while maintaining aspect ratio."
    echo "Applies lossy compression with a specified quality setting."
    echo ""
    echo "Options:"
    echo "  -i <directory>    : Required. The directory containing the images to process."
    echo "  -o <directory>    : Optional. The directory where converted WebP images will be saved."
    echo "                      Default: '$OUTPUT_DIR'"
    echo "  -w <width>        : Optional. The desired width in pixels for resized images."
    echo "                      Height will be automatically calculated to maintain aspect ratio."
    echo "                      Default: $RESIZE_WIDTH"
    echo "  -q <quality>      : Optional. WebP quality (0-100). Higher values mean better quality"
    echo "                      and larger file sizes. Recommended range: 70-90."
    echo "                      Default: $WEBP_QUALITY"
    echo "  -h                : Display this help message."
    exit 1
}

# --- Main Script ---

# Parse command-line arguments
while getopts "i:o:w:q:h" opt; do
    case ${opt} in
        i )
            INPUT_DIR="$OPTARG"
            ;;
        o )
            OUTPUT_DIR="$OPTARG"
            ;;
        w )
            RESIZE_WIDTH="$OPTARG"
            if ! [[ "$RESIZE_WIDTH" =~ ^[0-9]+$ ]] || [ "$RESIZE_WIDTH" -le 0 ]; then
                echo "Error: Width must be a positive integer." >&2
                usage
            fi
            ;;
        q )
            WEBP_QUALITY="$OPTARG"
            if ! [[ "$WEBP_QUALITY" =~ ^[0-9]+$ ]] || [ "$WEBP_QUALITY" -lt 0 ] || [ "$WEBP_QUALITY" -gt 100 ]; then
                echo "Error: Quality must be an integer between 0 and 100." >&2
                usage
            fi
            ;;
        h )
            usage
            ;;
        \? )
            echo "Invalid option: -$OPTARG" >&2
            usage
            ;;
    esac
done
shift $((OPTIND -1))

# Check if input directory is provided
if [ -z "$INPUT_DIR" ]; then
    echo "Error: Input directory is required." >&2
    usage
fi

# Check if input directory exists
if [ ! -d "$INPUT_DIR" ]; then
    echo "Error: Input directory '$INPUT_DIR' does not exist." >&2
    exit 1
fi

# Create output directory if it doesn't exist
mkdir -p "$OUTPUT_DIR"
if [ ! -d "$OUTPUT_DIR" ]; then
    echo "Error: Could not create output directory '$OUTPUT_DIR'." >&2
    exit 1
fi

echo "--- Image Conversion and Resizing Script ---"
echo "Input Directory : $INPUT_DIR"
echo "Output Directory: $OUTPUT_DIR"
echo "Target Width    : ${RESIZE_WIDTH}px"
echo "WebP Quality    : $WEBP_QUALITY"
echo "------------------------------------------"
echo ""

# Find and process images
# Use -print0 and read -d $'\0' for safe handling of filenames with spaces or special characters
find "$INPUT_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" -o -iname "*.bmp" -o -iname "*.tiff" -o -iname "*.tif" \) -print0 | \
while IFS= read -r -d $'\0' image_path; do
    filename=$(basename -- "$image_path")
    filename_no_ext="${filename%.*}" # Remove extension

    output_file="${OUTPUT_DIR}/${filename_no_ext}.webp"

    echo "Processing: $image_path"
    echo "  -> Output: $output_file"

    # FFmpeg command to resize and convert to WebP with compression
    ffmpeg -i "$image_path" -vf "scale=${RESIZE_WIDTH}:-1" -q:v "$WEBP_QUALITY" "$output_file"
    
    if [ $? -ne 0 ]; then
        echo "WARNING: Failed to process '$image_path'. Skipping."
    else
        echo "  Successfully processed."
    fi
    echo "" # Add an empty line for better readability between files

done

echo "------------------------------------------"
echo "All eligible images processed."
echo "Output images are located in: $OUTPUT_DIR"
echo "------------------------------------------"
