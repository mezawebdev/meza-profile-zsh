#!/usr/bin/env python3

import subprocess
import sys
import os
import json
import urllib.request
import urllib.error
from typing import Any

API_KEY = os.getenv("GOOGLE_GEMINI_API_KEY")
API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent"
MODEL = "glm-4.5-air"


def get_staged_diff():
    """Get the staged diff from git."""
    try:
        result = subprocess.run(
            ["git", "diff", "--cached"],
            capture_output=True, text=True, check=True
        )
        return result.stdout.strip()
    except subprocess.CalledProcessError:
        print("Error: Could not read git diff.", file=sys.stderr)
        sys.exit(1)


def copy_to_clipboard(text):
    """Runs pbcopy internally so Lazygit doesn't have to manage pipes."""
    try:
        process = subprocess.Popen(
            'pbcopy', env={'LANG': 'en_US.UTF-8'}, stdin=subprocess.PIPE)
        process.communicate(text.encode('utf-8'))
    except Exception as e:
        print(f"Clipboard Error: {e}", file=sys.stderr)


def show_notification(message):
    """
    Uses macOS native 'osascript' to show a notification.
    This works even in the background!
    """
    try:
        cmd = [
            'osascript',
            '-e',
            f'display notification "{message}" with title "Lazygit AI"'
        ]
        subprocess.run(cmd, check=False)
    except Exception:
        pass  # Ignore if it fails, it's just a nicety


def generate_commit_message(diff: str):
    """Call Z.ai / GLM-4 API to generate a commit message."""
    if not API_KEY:
        print("Error: Z_AI_API_KEY environment variable not set.", file=sys.stderr)
        sys.exit(1)

    if not diff:
        print("No staged changes to commit.", file=sys.stderr)
        sys.exit(0)

    # Truncate diff if it's too massive to save costs/tokens
    if len(diff) > 2000:
        diff = diff[:4000] + "\n...[diff truncated]"

    prompt = (
        "Write a concise, conventional commit message for these changes. "
        "Format: <type>: <subject>. Do not use markdown code blocks. "
        "Do not explain the changes, just give the message. "
        f"\n\nChanges:\n{diff}"
    )

    headers = {
        "Content-Type": "application/json",
        # "Authorization": f"Bearer {API_KEY}",
        "x-goog-api-key": API_KEY,
        # "Accept-Language": "en-US,en"
    }
    payload: dict[str, Any] = {
        # "model": MODEL,
        "contents": [
            {
                "parts": [
                    {
                        "text": prompt
                    }
                ]
            }
        ],
        "generationConfig": {
            "maxOutputTokens": 2000,
        }
        # "temperature": 0.5,
        # "max_tokens": 2000
    }

    try:
        req = urllib.request.Request(
            API_URL,
            data=json.dumps(payload).encode('utf-8'),
            headers=headers,
            method="POST"
        )

        with urllib.request.urlopen(req) as response:
            result = json.loads(response.read().decode('utf-8'))

            if 'candidates' in result:
                return result['candidates'][0]['content']['parts'][0]['text'].strip()

            if 'choices' in result:
                return result['choices'][0]['message']['content'].strip()

            if 'error' in result:
                print(f"API Error: {result['error']}", file=sys.stderr)
                sys.exit(1)

            print("Error: Unknown JSON format received.", file=sys.stderr)
            sys.exit(1)

    except urllib.error.HTTPError as e:
        print(f"API Error: {e.code} {e.reason}", file=sys.stderr)
        print(e.read().decode('utf-8'), file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"Unexpected Error: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    diff = get_staged_diff()
    msg = generate_commit_message(diff)

    if msg:
        copy_to_clipboard(msg)
        show_notification("Commit message copied to clipboard!")
        print(msg)
